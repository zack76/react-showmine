{"ast":null,"code":"import _Date$now from \"@babel/runtime-corejs2/core-js/date/now\";\nimport _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport BaseService from './BaseService';\nimport { Config } from '../Config';\nimport jQuery from 'jquery';\nimport md5 from 'md5';\nvar local_storage_key = 'wx';\nvar js_expires_in_seconds = 7000;\n\nvar WeChatService =\n/*#__PURE__*/\nfunction () {\n  function WeChatService() {\n    _classCallCheck(this, WeChatService);\n\n    _defineProperty(this, \"getWeChatJsConf\", function (params) {\n      return BaseService.get(Config.webApi + 'wechat/js/conf', params);\n    });\n  }\n\n  _createClass(WeChatService, [{\n    key: \"initWeChatJsConfig\",\n    value: function initWeChatJsConfig(url, jsConfigs) {\n      if (wx && typeof wx.config === 'function') {\n        wx.config(jsConfigs);\n        this.setCachedJsConfig(url, jsConfigs);\n      }\n    }\n  }, {\n    key: \"getJsCacheKey\",\n    value: function getJsCacheKey(url) {\n      return this.md5Hash(url);\n    }\n  }, {\n    key: \"setJsCache\",\n    value: function setJsCache(url, value) {\n      var cached = localStorage.getItem(local_storage_key);\n      var jsonCached = JSON.parse(cached);\n\n      if (!cached) {\n        cached = {};\n      }\n\n      if (!jsonCached) {\n        jsonCached = {};\n      }\n\n      jsonCached[this.getJsCacheKey(url)] = value;\n      localStorage.setItem(local_storage_key, _JSON$stringify(jsonCached));\n      return this;\n    }\n  }, {\n    key: \"getJsCache\",\n    value: function getJsCache(url) {\n      var cached = localStorage.getItem(local_storage_key);\n      var jsonCached = JSON.parse(cached);\n      return jsonCached ? jsonCached[this.getJsCacheKey(url)] : null;\n    }\n  }, {\n    key: \"getCachedJsConfig\",\n    value: function getCachedJsConfig(url) {\n      var tmp = {};\n      tmp.stored_config = this.getJsCache(url);\n\n      if (typeof tmp.stored_config === 'object' && tmp.stored_config && tmp.stored_config.timestamp !== '') {\n        tmp.now_unix_timestamp = Math.floor(_Date$now() / 1000); // cache expired\n\n        if (tmp.now_unix_timestamp * 1 - tmp.stored_config.timestamp * 1 <= js_expires_in_seconds) {\n          return tmp.stored_config;\n        }\n      }\n\n      return undefined;\n    }\n  }, {\n    key: \"setCachedJsConfig\",\n    value: function setCachedJsConfig(url, jsConfigs) {\n      this.setJsCache(url, jsConfigs);\n      return this;\n    }\n  }, {\n    key: \"loadWeChatJsConf\",\n    value: function loadWeChatJsConf(url, configs) {\n      var _this = this;\n\n      var cachedConfig = this.getCachedJsConfig(url);\n\n      if (cachedConfig) {\n        this.initWeChatJsConfig(url, cachedConfig);\n\n        if (configs && configs.loaded) {\n          configs.loaded();\n        }\n\n        return this;\n      }\n\n      this.getWeChatJsConf({\n        'url': url\n      }).then(function (response) {\n        return response.json();\n      }).then(function (resp) {\n        if (resp.js) {\n          _this.initWeChatJsConfig(url, resp.js);\n\n          if (configs !== undefined) {\n            _this.runJs(configs);\n          }\n        }\n      });\n      return this;\n    }\n  }, {\n    key: \"runWhenWXReady\",\n    value: function runWhenWXReady(func) {\n      if (wx && typeof wx.ready === 'function' && typeof func === 'function') {\n        wx.ready(function () {\n          func();\n        });\n      }\n    }\n  }, {\n    key: \"runJs\",\n    value: function runJs(configs) {\n      jQuery(document).ready(function () {\n        // delay 500 ms to execute wx.ready\n        setTimeout(function () {\n          wx.ready(function (res) {\n            if (configs.menuShareAppMessage) {\n              wx.onMenuShareAppMessage(configs.menuShareAppMessage);\n            }\n\n            if (configs.menuShareTimeline) {\n              wx.onMenuShareTimeline(configs.menuShareTimeline);\n            }\n\n            if (configs.getLocation) {\n              wx.getLocation({\n                type: 'wgs84',\n                // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'\n                success: function success(res) {\n                  if (typeof configs.getLocation.success === 'function') {\n                    configs.getLocation.success(res);\n                  }\n                },\n                fail: function fail(res) {\n                  if (typeof configs.getLocation.fail === 'function') {\n                    configs.getLocation.fail(res);\n                  }\n                }\n              });\n            }\n\n            if (configs.loaded && typeof configs.loaded === 'function') {\n              configs.loaded(res);\n            }\n          });\n        }, 1000);\n      });\n    }\n  }, {\n    key: \"md5Hash\",\n    value: function md5Hash(string) {\n      return md5(string);\n    }\n  }]);\n\n  return WeChatService;\n}();\n\nvar weChatService = new WeChatService();\nexport default weChatService;","map":null,"metadata":{},"sourceType":"module"}