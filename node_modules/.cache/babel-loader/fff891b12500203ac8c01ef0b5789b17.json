{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport React, { Component } from 'react';\nimport '../App.css';\nimport 'weui';\nimport 'react-weui/build/packages/react-weui.css';\nimport ItemService from '../../service/ItemService';\nimport SiteHeader from '../../components/Common/SiteHeader';\nimport SiteFooter from \"../../components/Common/SiteFooter\";\nimport JieLongDetailComponent from \"../../components/ItemDetails/JieLongDetails/JieLongDetailComponent\";\nimport ProductDetailComponent from \"../../components/ItemDetails/ProductDetails/ProductDetailComponent\";\nimport ArticleDetailComponent from \"../../components/ItemDetails/ArticleDetails/ArticleDetailComponent\";\nimport RegistrationDetailComponent from \"../../components/ItemDetails/RegistrationDetails/RegistrationDetailComponent\";\nimport WeChatService from '../../service/WeChatService';\nimport UtilsService from \"../../service/UtilsService\";\nimport { Row, Col, Container } from 'react-bootstrap';\nimport AuthService from \"../../service/AuthService\";\nimport { withRouter } from \"next/router\";\nimport ReactGA from 'react-ga';\nimport { Helmet } from 'react-helmet';\n\nvar itemDetail =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(itemDetail, _Component);\n\n  function itemDetail(props) {\n    var _this;\n\n    _classCallCheck(this, itemDetail);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(itemDetail).call(this, props));\n\n    _defineProperty(_assertThisInitialized(_this), \"recordVisitHistory\",\n    /*#__PURE__*/\n    _asyncToGenerator(\n    /*#__PURE__*/\n    _regeneratorRuntime.mark(function _callee() {\n      var itemId, from, sharerId, params;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(_this.props.router && _this.props.router.query && _this.props.router.query.from && _this.props.item)) {\n                _context.next = 7;\n                break;\n              }\n\n              itemId = _this.props.item.id;\n              from = _this.props.router.query.from;\n              sharerId = _this.props.router.query.sharerId;\n              params = {\n                itemId: itemId,\n                from: from,\n                sharerId: sharerId,\n                fromWeChat: true\n              };\n              _context.next = 7;\n              return ItemService.recordVisitHistory(params);\n\n            case 7:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    })));\n\n    _defineProperty(_assertThisInitialized(_this), \"weChatShare\", function () {\n      var item = _this.state.item;\n      var currentUrl = _this.state.currentUrl;\n\n      if (localStorage.getItem('userObject')) {\n        var currentUserId = JSON.parse(localStorage.getItem('userObject')).id;\n        var url = new URL(currentUrl);\n        var query_string = url.search;\n        var search_params = new URLSearchParams(query_string);\n\n        if (search_params.has('sharerId')) {\n          search_params.set('sharerId', currentUserId);\n          url.search = search_params.toString();\n          currentUrl = url.toString();\n        } else {\n          currentUrl = currentUrl + '&sharerId=' + currentUserId;\n        }\n      }\n\n      var imageSize = 'SMALL';\n      var descWithoutHtml = UtilsService.stripHtmlTags(item.description);\n      WeChatService.runWhenWXReady(function () {\n        wx.onMenuShareAppMessage({\n          title: item.title,\n          desc: descWithoutHtml,\n          link: currentUrl,\n          imgUrl: UtilsService.getItemImgUrlWithSize(item, imageSize)\n        });\n        wx.onMenuShareTimeline({\n          title: item.title,\n          link: currentUrl,\n          imgUrl: UtilsService.getItemImgUrlWithSize(item, imageSize)\n        });\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"loginWithTempCode\", function (tmpToken) {\n      AuthService.loginWithTempCode(tmpToken).then(function (response) {\n        return response.text();\n      }).then(function (resp) {\n        var res = JSON.parse(resp);\n\n        if (res.return_code) {\n          localStorage.setItem('userToken', res.return_code);\n          localStorage.setItem('isLogIn', true);\n        }\n\n        var params = {};\n        AuthService.getMe(params).then(function (response) {\n          return response.json();\n        }).then(function (responseJson) {\n          localStorage.setItem('userObject', _JSON$stringify(responseJson));\n        }).then(function () {\n          location.reload();\n        }).catch(function (error) {\n          console.error(error);\n        });\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getLoginStatus\", function () {\n      if (!UtilsService.openedInWeChat() && !localStorage.getItem('userToken')) {\n        if (_this.state.subscribeLoginLogId) {\n          AuthService.checkLoginStatus(_this.state.subscribeLoginLogId || null).then(function (response) {\n            return response.text();\n          }).then(function (resp) {\n            var res = JSON.parse(resp);\n\n            if (res.log && res.log.tmp_token && res.log.tmp_token.trim() !== '') {\n              _this.setState({\n                loading: true\n              });\n\n              _this.loginWithTempCode(res.log.tmp_token.trim());\n            }\n          });\n        }\n      } else {\n        clearInterval(_this.state.interval);\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"getCompanyQrCode\", function (item) {\n      // let params = {\n      //     itemId: item.id\n      // };\n      var getLoginStatus = _this.getLoginStatus;\n      var params = {\n        companyId: item && item.company && item.company.id,\n        itemId: item && item.id\n      };\n      AuthService.getLoginSubscribeQrCode(params).then(function (response) {\n        return response.text();\n      }).then(function (response) {\n        var res = JSON.parse(response);\n        var interval = setInterval(getLoginStatus, 1000);\n\n        _this.setState({\n          qrUrl: res.qrcode,\n          subscribeLoginLogId: res.subscribeLoginLogId,\n          interval: interval\n        });\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"extractContent\", function (desc) {\n      var span = document.createElement('span');\n      span.innerHTML = desc;\n      return span.textContent || span.innerText;\n    });\n\n    _this.state = {\n      item: _this.props.item,\n      isLogin: false,\n      itemType: _this.props.item.predefinedTags['1']\n    };\n    return _this;\n  }\n\n  _createClass(itemDetail, [{\n    key: \"initializeReactGA\",\n    value: function initializeReactGA() {\n      ReactGA.initialize('UA-101510131-7'); // ReactGA.initialize('UA-154886136-1');\n\n      ReactGA.pageview('/itemDetails');\n      ReactGA.event({\n        category: 'ItemDetails',\n        action: 'View item details'\n      });\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      this.getCompanyQrCode(this.state.item);\n      this.setState({\n        isLogin: localStorage.getItem('isLogIn'),\n        currentUrl: window.location.href\n      }, function () {\n        setTimeout(function () {\n          _this2.weChatShare();\n        }, 300);\n      });\n      this.recordVisitHistory();\n      this.initializeReactGA();\n    }\n  }, {\n    key: \"componentWillReceiveProps\",\n    value: function componentWillReceiveProps(object, nextProps) {\n      var _this3 = this;\n\n      this.setState({\n        item: object.item,\n        currentUrl: window.location.href,\n        itemType: object.item.predefinedTags['1']\n      }, function () {\n        setTimeout(function () {\n          _this3.weChatShare();\n        }, 500);\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this4 = this;\n\n      var item = this.state.item ? this.state.item : undefined;\n      var isLogin = this.state.isLogin;\n\n      if (item) {\n        var itemView = function itemView() {\n          switch (_this4.state.itemType) {\n            case 'JIE LONG':\n              return React.createElement(JieLongDetailComponent, {\n                isLogin: isLogin,\n                item: item\n              });\n\n            case 'product':\n              return React.createElement(ProductDetailComponent, {\n                isLogin: isLogin,\n                item: item\n              });\n\n            case 'CONSULTATION':\n              return React.createElement(ArticleDetailComponent, {\n                isLogin: isLogin,\n                item: item\n              });\n\n            case 'REGISTRATION':\n              return React.createElement(RegistrationDetailComponent, {\n                isLogin: isLogin,\n                item: item\n              });\n\n            default:\n              return React.createElement(ProductDetailComponent, {\n                isLogin: isLogin,\n                item: item\n              });\n          }\n        };\n\n        return React.createElement(\"div\", {\n          className: \"App\",\n          key: item.id\n        }, React.createElement(Helmet, null, React.createElement(\"title\", null, item.title), React.createElement(\"meta\", {\n          name: \"description\",\n          content: item.description.replace(/<[^>]+>/g, '')\n        })), React.createElement(Container, null, React.createElement(Row, null, React.createElement(Col, {\n          sm: 12,\n          md: 8,\n          className: \"col-md-offset-2\"\n        }, React.createElement(SiteHeader, {\n          show: this.state.itemType !== 'CONSULTATION',\n          company: item.company ? item.company : undefined,\n          item: item\n        }), itemView(), React.createElement(SiteFooter, {\n          show: this.state.itemType !== 'CONSULTATION'\n        })), React.createElement(Col, {\n          sm: 12,\n          md: 2,\n          className: \"sticky\"\n        }, React.createElement(\"div\", {\n          style: styles.qrTitle\n        }, \"\\u626B\\u7801\\u5173\\u6CE8\\u8BE5\\u516C\\u53F8\"), React.createElement(\"div\", {\n          style: styles.qrTitle\n        }, React.createElement(\"small\", null, \"\\u5C06\\u66F4\\u53CA\\u65F6\\u7684\\u6536\\u5230\\u63A8\\u9001\")), React.createElement(\"img\", {\n          style: styles.qrcode,\n          src: this.state.qrUrl\n        })))));\n      } else return null;\n    }\n  }]);\n\n  return itemDetail;\n}(Component);\n\n_defineProperty(itemDetail, \"getInitialProps\",\n/*#__PURE__*/\nfunction () {\n  var _ref3 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee2(_ref2) {\n    var req, query, slug, res, json;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            req = _ref2.req, query = _ref2.query;\n            slug = encodeURIComponent(query.id);\n            _context2.next = 4;\n            return ItemService.getItemDetailBySlug(slug);\n\n          case 4:\n            res = _context2.sent;\n            _context2.next = 7;\n            return res.json();\n\n          case 7:\n            json = _context2.sent;\n            return _context2.abrupt(\"return\", {\n              item: json\n            });\n\n          case 9:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function (_x) {\n    return _ref3.apply(this, arguments);\n  };\n}());\n\nvar styles = {\n  qrcode: {\n    width: '100%'\n  },\n  qrTitle: {\n    width: '100%',\n    textAlign: 'center'\n  }\n};\nexport default withRouter(itemDetail);","map":null,"metadata":{},"sourceType":"module"}