{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime-corejs2/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport React, { Component } from 'react';\nimport './App.css';\nimport { Button, Cells, Cell, CellBody, CellFooter, ActionSheet, Toast, Gallery } from 'react-weui';\nimport ItemService from '../service/ItemService';\nimport JielongService from '../service/JielongService';\nimport AuthService from \"../service/AuthService\";\nimport Router from 'next/router';\nimport SiteHeader from '../components/Common/SiteHeader';\nimport Link from 'next/link'; //import styles\n\nimport 'weui';\nimport 'react-weui/build/packages/react-weui.css'; //import component\n\nimport Swipe from '../components/Swipe';\nimport Head from \"../components/head\";\nimport ProductCardGrid from \"../components/ProductCards/ProductCardGrid\";\nimport ChildrenList from '../components/JieLongDetails/ChildrenList';\nimport JielongContent from '../components/JieLongDetails/JieLongContent';\nimport Footer from \"../components/Footer\";\nimport Lang from '../lang/Lang';\nimport { Config } from \"../Config\";\nimport JieLongBanner from \"../components/JieLongDetails/JieLongBanner\";\n\nvar App =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(App, _Component);\n\n  function App(props) {\n    var _this;\n\n    _classCallCheck(this, App);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(App).call(this, props));\n    _this.state = {\n      item: _this.props.item,\n      productList: undefined,\n      showLoading: false,\n      userJieLongInfo: '',\n      isLogin: false,\n      iosShow: false,\n      showVoucher: false,\n      actions: [{\n        label: '取消',\n        onClick: _this.hide.bind(_assertThisInitialized(_this))\n      }]\n    };\n    return _this;\n  }\n\n  _createClass(App, [{\n    key: \"hide\",\n    value: function hide() {\n      this.setState({\n        iosShow: false\n      });\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.getIsInCurrentJieLong();\n\n      if (this.state.item.multi_participations) {\n        this.getAllJielong();\n      }\n\n      this.getRelatedProducts();\n      this.setState({\n        isLogin: localStorage.getItem('isLogIn')\n      });\n    }\n  }, {\n    key: \"componentWillReceiveProps\",\n    value: function componentWillReceiveProps(object, nextProps) {\n      this.setState({\n        item: object.item\n      });\n    }\n  }, {\n    key: \"getRelatedProducts\",\n    value: function getRelatedProducts() {\n      var _this2 = this;\n\n      var params = this.state.item.company_id + '?is_draft=0&is_sync_to_market=1&page=1&page-size=6';\n      ItemService.getRelatedProducts(params).then(function (response) {\n        return response.json();\n      }).then(function (responseJson) {\n        _this2.setState({\n          productList: responseJson\n        });\n      }).catch(function (error) {\n        console.error(error);\n      });\n    }\n  }, {\n    key: \"shouldComponentUpdate\",\n    value: function shouldComponentUpdate(nextProps) {\n      return this.state !== nextProps;\n    }\n  }, {\n    key: \"getIsInCurrentJieLong\",\n    value: function getIsInCurrentJieLong() {\n      var _this3 = this;\n\n      // localStorage.setItem('userToken', 'e3d1444b340a4ee60a22c136d6d8de1f');\n      // localStorage.setItem('isLogIn', true);\n      var id = this.state.item.id;\n      JielongService.getIsInCurrentJieLong(id).then(function (response) {\n        return response.json();\n      }).then(function (responseJson) {\n        _this3.setState({\n          userJieLongInfo: responseJson\n        });\n      }).catch(function (error) {\n        console.error(error);\n      });\n    }\n  }, {\n    key: \"getAllJielong\",\n    value: function getAllJielong() {\n      var _this4 = this;\n\n      var id = this.state.item.id;\n      var isLogIn = localStorage.getItem('isLogIn');\n\n      if (isLogIn) {\n        JielongService.getAllJielong(id).then(function (response) {\n          return response.json();\n        }).then(function (responseJson) {\n          _this4.setState({\n            allJielongInfo: responseJson\n          });\n        }).catch(function (error) {\n          console.error(error);\n        });\n      }\n    }\n  }, {\n    key: \"cancelJielong\",\n    value: function cancelJielong() {\n      var _this5 = this;\n\n      this.hide();\n      this.setState({\n        showLoading: true\n      });\n      var id = this.state.userJieLongInfo.currentUserJieLong.id;\n      var url = \"https://www.showmine66.com/ma/i/\" + this.state.item.id;\n      var params = {};\n      JielongService.cancelJielong(id, url, params).then(function (response) {\n        return response.json();\n      }).then(function (responseJson) {\n        _this5.setState({\n          showLoading: false\n        });\n\n        window.location.reload();\n      }).catch(function (error) {\n        console.error(error);\n      });\n    }\n  }, {\n    key: \"updateJielong\",\n    value: function updateJielong() {\n      var itemId = {\n        itemId: this.state.item.id,\n        is_update: true,\n        jielongId: this.state.userJieLongInfo.currentUserJieLong.id\n      };\n      Router.push({\n        pathname: '/checkoutPage',\n        query: itemId\n      });\n    }\n  }, {\n    key: \"checkLoginStatus\",\n    value: function checkLoginStatus() {\n      var itemId = {\n        itemId: this.state.item.id\n      };\n      var isLogIn = localStorage.getItem('isLogIn');\n\n      if (isLogIn) {\n        Router.push({\n          pathname: '/checkoutPage',\n          query: itemId\n        });\n      } else {\n        this.weChatLogin();\n      }\n    }\n  }, {\n    key: \"weChatLogin\",\n    value: function weChatLogin() {\n      var origUrl = this.state.item.id; // let authUrl = \"http://localhost:3000/AuthPage\";\n\n      var authUrl = Config.webAddress + \"AuthPage\";\n      var params = {};\n      AuthService.wechatLogin(origUrl, authUrl, params).then(function (response) {\n        return response.json();\n      }).then(function (responseJson) {\n        window.open(responseJson.auth_url, \"_self\");\n      }).catch(function (error) {\n        console.error(error);\n        alert(error);\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this6 = this;\n\n      var userJieLongInfo = this.state.userJieLongInfo;\n      var productList = this.state.productList && this.state.productList.data ? this.state.productList.data : undefined;\n      var item = this.state.item ? this.state.item : undefined;\n      var allJielongInfo = this.state.allJielongInfo ? this.state.allJielongInfo : undefined;\n      return React.createElement(\"div\", {\n        className: \"App\"\n      }, React.createElement(SiteHeader, null), React.createElement(\"div\", {\n        className: \"App-body\",\n        key: item.id\n      }, React.createElement(JieLongBanner, {\n        images: item.images\n      }), React.createElement(JielongContent, {\n        jieLongDetail: item ? item : undefined\n      }), this.state.isLogin && userJieLongInfo && userJieLongInfo.currentUserJieLong && userJieLongInfo.currentUserJieLong.voucher && userJieLongInfo.currentUserJieLong.voucher.refnum && !item.multi_participations ? React.createElement(Cells, null, React.createElement(Cell, {\n        href: userJieLongInfo.currentUserJieLong.voucher.img_url,\n        access: true\n      }, React.createElement(CellBody, null, React.createElement(\"div\", {\n        className: \"isInJielong-row\"\n      }, React.createElement(\"div\", null, React.createElement(\"span\", {\n        className: \"tag-icon\"\n      }, \"\\u53C2\\u52A0\\u6210\\u529F\"), \" \\u56DE\\u6267\\u7801\\uFF1A\", React.createElement(\"span\", {\n        className: \"Ref-num\"\n      }, userJieLongInfo.currentUserJieLong.voucher.refnum)))), React.createElement(CellFooter, null))) : null, React.createElement(Cells, null, this.state.isLogin && allJielongInfo ? allJielongInfo.map(function (jieLong) {\n        return React.createElement(\"div\", {\n          key: jieLong.id\n        }, React.createElement(Cell, {\n          href: undefined,\n          onClick: function onClick(e) {\n            return _this6.setState({\n              showVoucher: true\n            });\n          },\n          access: true\n        }, React.createElement(CellBody, null, jieLong && jieLong.is_paid && jieLong.voucher && jieLong.voucher.receipt && jieLong.voucher.receipt.amount && jieLong.voucher.refnum ? React.createElement(\"div\", {\n          className: \"allJielongInfo\"\n        }, React.createElement(\"div\", null, React.createElement(\"span\", {\n          className: \"paidAmount-icon\"\n        }, \"\\u5DF2\\u652F\\u4ED8\\uFF1A$\", jieLong.voucher.receipt.amount), \" \\u56DE\\u6267\\u7801\\uFF1A\", React.createElement(\"span\", {\n          className: \"Ref-num\"\n        }, jieLong.voucher.refnum))) : React.createElement(\"div\", {\n          className: \"isInJielong-row\"\n        }, jieLong.voucher && jieLong.voucher.refnum ? React.createElement(\"div\", null, React.createElement(\"span\", {\n          className: \"tag-icon\"\n        }, \"\\u53C2\\u52A0\\u6210\\u529F\"), \" \\u56DE\\u6267\\u7801\\uFF1A\", React.createElement(\"span\", {\n          className: \"Ref-num\"\n        }, jieLong.voucher.refnum)) : React.createElement(\"div\", null, \"\\u63D0\\u793A\\uFF1A\\u8BF7\\u572830\\u5206\\u949F\\u5185\\u5B8C\\u6210\\u652F\\u4ED8\\uFF0C\\u5426\\u5219\\u8BA2\\u5355\\u4F1A\\u64A4\\u9500\"))), React.createElement(CellFooter, null)), React.createElement(Gallery, {\n          src: jieLong.voucher && jieLong.voucher.img_url ? jieLong.voucher.img_url : undefined,\n          show: _this6.state.showVoucher\n        }, React.createElement(\"div\", {\n          style: styles.galleryButton,\n          onClick: function onClick(e) {\n            return _this6.setState({\n              showVoucher: false\n            });\n          }\n        }, \"Cancel\")));\n      }) : null), React.createElement(ChildrenList, {\n        children: item.children ? item.children : undefined\n      }), item.company ? React.createElement(\"div\", null, React.createElement(Link, {\n        href: {\n          pathname: '/companyDetails',\n          query: {\n            companyId: item.company.id\n          }\n        }\n      }, React.createElement(\"a\", null, React.createElement(\"div\", {\n        className: \"company-info\"\n      }, React.createElement(\"div\", {\n        className: \"company-img\"\n      }, React.createElement(\"img\", {\n        height: 100,\n        src: item.company.logo_img.url,\n        role: \"presentation\"\n      })), React.createElement(\"div\", {\n        className: \"company-content\"\n      }, React.createElement(\"div\", {\n        className: \"company-title\"\n      }, item.company.name), React.createElement(\"div\", {\n        className: \"company-followers\"\n      }, \"\\u5173\\u6CE8\\u91CF\\uFF1A\", item.company.followers))))), React.createElement(\"div\", {\n        className: \"divider\"\n      })) : null, React.createElement(\"div\", {\n        className: \"related-product\"\n      }, React.createElement(ProductCardGrid, {\n        productList: productList\n      })), React.createElement(Footer, null), React.createElement(\"div\", {\n        className: \"button-area\"\n      }, this.state.isLogin && userJieLongInfo && userJieLongInfo.currentUserJieLong && !userJieLongInfo.currentUserJieLong.is_paid ? React.createElement(\"div\", null, React.createElement(Button, {\n        type: \"primary\",\n        onClick: function onClick(e) {\n          return _this6.setState({\n            iosShow: true\n          });\n        }\n      }, \"\\u4FEE\\u6539\\u8BA2\\u5355\"), React.createElement(ActionSheet, {\n        menus: [{\n          label: '修改团购',\n          onClick: function onClick() {\n            _this6.updateJielong();\n          }\n        }, {\n          label: '取消团购',\n          onClick: function onClick() {\n            _this6.cancelJielong();\n          }\n        }],\n        actions: this.state.actions,\n        show: this.state.iosShow,\n        type: \"ios\",\n        onRequestClose: function onRequestClose(e) {\n          return _this6.setState({\n            iosShow: false\n          });\n        },\n        style: {\n          color: 'black'\n        }\n      }), React.createElement(Toast, {\n        icon: \"loading\",\n        show: this.state.showLoading\n      }, \"Loading...\")) : React.createElement(Button, {\n        type: \"primary\",\n        className: \"button\",\n        onClick: function onClick() {\n          _this6.checkLoginStatus();\n        }\n      }, \"\\u9A6C\\u4E0A\\u4E0B\\u5355\"))));\n    }\n  }]);\n\n  return App;\n}(Component);\n\n_defineProperty(App, \"getInitialProps\",\n/*#__PURE__*/\nfunction () {\n  var _ref2 = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee(_ref) {\n    var req, query, res, json;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            req = _ref.req, query = _ref.query;\n            res = '';\n\n            if (!query.itemId) {\n              _context.next = 8;\n              break;\n            }\n\n            _context.next = 5;\n            return ItemService.getItemDetail(query.itemId);\n\n          case 5:\n            res = _context.sent;\n            _context.next = 11;\n            break;\n\n          case 8:\n            _context.next = 10;\n            return ItemService.getItemDetail('a3067bcbd7521b4965ef8b43394aa011');\n\n          case 10:\n            res = _context.sent;\n\n          case 11:\n            _context.next = 13;\n            return res.json();\n\n          case 13:\n            json = _context.sent;\n            return _context.abrupt(\"return\", {\n              item: json\n            });\n\n          case 15:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function (_x) {\n    return _ref2.apply(this, arguments);\n  };\n}());\n\nvar styles = {\n  galleryButton: {\n    color: 'white',\n    fontWeight: 'bold',\n    padding: '0'\n  }\n};\nexport default App;","map":null,"metadata":{},"sourceType":"module"}